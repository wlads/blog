	
	<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Evitando problemas com datas e time zones no Rails - Blog da HE:labs</title>
  <meta name="author" content="Time HE:labs">

  
  <meta name="description" content="Evitando problemas com datas e time zones no Rails Volta e meia passo por alguns problemas com time zones no Rails. Hoje, demonstrarei algumas dicas &hellip;">
  

  <!-- Facebook stuff taken from main page, not sure it should go here -->
  <meta property="og:title" content="Evitando problemas com datas e time zones no Rails - Blog da HE:labs"/>
  <meta property="og:site_name" content="HE:labs blog"/>
  <meta property="og:image" content="http://helabs.com.br/images/logo-icon.png"/>
  <meta property="og:description" content="Evitando problemas com datas e time zones no Rails Volta e meia passo por alguns problemas com time zones no Rails. Hoje, demonstrarei algumas dicas &hellip;" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://helabs.com.br/blog/2013/06/11/evitando-problemas-com-datas-e-time-zones-no-rails/">
  <link href="http://helabs.com.br/favicon.png" rel="icon">

  <!-- CSS --> 
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <!-- JS -->
  <script type="text/javascript" src="/blog/javascripts/jquery.js"></script>
  <script type="text/javascript" src="/blog/javascripts/jquery.parallax.min.js"></script>
  <script type="text/javascript" src="/blog/javascripts/main.js"></script>

  <!--
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  -->
  
  <link href="/blog/atom.xml" rel="alternate" title="Blog da HE:labs" type="application/atom+xml">
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16326763-1']);
  _gaq.push(['_setDomainName', 'helabs.com.br']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
	<body   >
		
		<!-- #top -->
<header id="top">
	<div class="grid">
		<h1 class="title">
			<a href="/">
				<img src="/blog/images/logotipo.png" />
			</a>
		</h1>	
	</div>
</header>
<!-- /#top -->

	    <div id="content">
	    	    <!-- #posts -->
    <section id="posts" class="single">    
      <article>
  <div class="grid">

    
      <h1 class="post-title">Evitando problemas com datas e time zones no Rails</h1>
    


    
      <div class="text"><p>Volta e meia passo por alguns <strong>problemas com time zones no Rails</strong>. Hoje, demonstrarei algumas dicas para evitá-los:</p>

<!-- more -->


<p>A primeira coisa a ser feita para evitar problemas é <strong>setar a time zone do projeto</strong> no <code>config/application.rb</code> para Brasília (se o site for basileiro): <code>config.time_zone = 'Brasilia'</code> e não para &#8220;UTC -3&#8221; ou algo do gênero; de forma a evitar problemas com horário de verão também.</p>

<p>Dessa forma, o Rails permanecerá a hora certa para que seja salva no banco de dados corretamente em UTC 0, como mandam as regras. Da mesma forma, quando você puxar algo salvo no banco em UTC 0, ele já mostrará na tela a time zone do projeto utilizada corretamente.</p>

<p>Só que não!</p>

<p>O problema é que o Rails tem métodos que retornam a data em UTC 0 e outros, de acordo com a time zone do projeto.</p>

<p>Porém, a <strong>boa notícia</strong> é que você pode seguir essa cheat sheet sempre que for trabalhar com time zones para não ter problemas e rapidamente irá decorar quais métodos devem ou não ser usados.</p>

<h2>Não use</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="c1"># =&gt; Retorna o horário do sistema e ignora a time zone do projeto.</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2012-03-02 16:05:37&quot;</span><span class="p">)</span> <span class="c1"># =&gt; Irá assumir que a string recebida tá na time zone do sistema.</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-%dT%H:%M:%S%z&#39;</span><span class="p">)</span> <span class="c1"># Mesmo problema do Time.parse.</span>
</span><span class='line'>  <span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="c1"># Pode ser ontem ou amanhã de acordo com a time zona setada na máquina.</span>
</span><span class='line'>  <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">to_time</span> <span class="c1"># =&gt; # Também não segue a time zone do projeto.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Use</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span> <span class="c1"># =&gt; Fri, 02 Mar 2012 20:04:47 UTC -03:00</span>
</span><span class='line'>  <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">from_now</span> <span class="c1"># =&gt; Fri, 03 Mar 2012 22:04:47 UTC -03:00</span>
</span><span class='line'>  <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">to_time_in_current_zone</span> <span class="c1"># =&gt; Fri, 02 Mar 2012 22:04:47 UTC -03:00</span>
</span><span class='line'>  <span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; Fri, 02 Mar</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2012-03-02 16:05:37&quot;</span><span class="p">)</span> <span class="c1"># =&gt; Fri, 02 Mar 2012 16:05:37 UTC -03:00</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span> <span class="c1"># =&gt; Fri, 02 Mar 2012 22:04:47 UTC -03:00</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">current</span> <span class="c1"># Mesma coisa, só que de forma mais curta.</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">today</span> <span class="c1"># Se você não pode usar Time ou DateTime.</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">iso8601</span> <span class="c1"># Quando for trabalhar com APIs.</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-%dT%H:%M:%S%z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in_time_zone</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="p">)</span> <span class="c1"># Se não pode usar Time.pars</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outra dica que recomendo é sempre escrever testes com horários limites. Exemplo: se quero uma query com os itens da semana passada, crio documentos no banco com domingo 23:59 e segunda 00:01, justamente para ter certeza de que não teremos problemas com time zone em lugar algum.</p>

<p>Fonte: <a href="http://www.elabs.se/blog/36-working-with-time-zones-in-ruby-on-rails">o excelente post da elabs.se</a> (quase nossa xará =p)</p>
</div>
    


    
      








  


<time datetime="2013-06-11T10:20:00-03:00" pubdate data-updated="true">Jun 11<span>th</span>, 2013</time>
    
  </div>
</article>  

      <aside id="more-information" class="grid">
        <p class="meta">
          
  

<span class="byline author vcard">Postado por <span class="fn">Cayo Medeiros (yogodoshi)</span></span>

          

<span class="categories">
  
    <a class='category' href='/blog/categories/data/'>data</a>, <a class='category' href='/blog/categories/hora/'>hora</a>, <a class='category' href='/blog/categories/time-zone/'>time zone</a>
  
</span>


        </p>

        
          <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://helabs.com.br/blog/2013/06/11/evitando-problemas-com-datas-e-time-zones-no-rails/" data-via="helabs" data-counturl="http://helabs.com.br/blog/2013/06/11/evitando-problemas-com-datas-e-time-zones-no-rails/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
    
        <p class="meta">
          
            <a class="basic-alignment left" href="/blog/2013/06/07/boas-vindas-aos-novos-integrantes/" title="Previous Post: Novos membros">&laquo;Novos membros</a>
          
      
          
            <a class="basic-alignment right" href="/blog/2013/06/17/refatoracao-parte-i-o-que-e/" title="Next Post: Refatoração Parte I - O que é?!">Refatoração Parte I - O que é?! &raquo;</a>
          
        </p>
    
        <div id="cover" class="cover-mailing-page">
          <div class="containner">
            <div class="mailing-form">
              <h2>Gostou desse post? Receba nossa newsletter e fique por dentro dos novos posts e outras novidades da HE:labs.</h2>
              <form style="width:100%" action="http://clientela.us2.list-manage.com/subscribe/post?u=78c4c9df5db794cd68f358456&amp;id=020e7504d2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>

                <input type="email" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Insira seu email e faça parte da comunidade" required />

                <input type="submit" value="Fazer Parte" name="subscribe" id="mc-embedded-subscribe" class="button"/>

              </form>
              <a href="http://antispam.br" target="_blank"><img src="http://helabs.com.br/images/antispam.jpg" title="Selo AntiSpam"></a>
              <p>
                <a href="http://helabs.com.br/privacidade" target="_blank" title="Política de Privacidade">Política de Privacidade</a> /
                <a href="http://helabs.us2.list-manage.com/unsubscribe?u=78c4c9df5db794cd68f358456&id=020e7504d2" target="_blank" title="Retirar o e-mail da lista">Retirar o e-mail da lista</a>
              </p>
            </div>
          </div>
        </div>

        
          <div id="disqus_thread" aria-live="polite">
            <h6>Comentários</h6>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

          </div>
        

      </aside>
    </section>
	    </div>

	  	<footer id="bottom">
  
  <div id="social-footer">
    <div class="grid">
    <a ref="#" class="github">Github</a>
    <a ref="#" class="twitter">Twitter</a>
    <a ref="#" class="facebook">Facebook</a>
    <a ref="#" class="rss">RSS</a>
    </div>
 </div>
 
	<div class="grid">
    <div class="collumn">
      <h3>Últimos Posts</h3>
      <ul>
        <li>Melhorando o Email Activity do SendGrid</li>
        <li>Um pouco sobre Lean UX</li>
        <li>Como colaborar com projetos open-source</li>
        <li>Retrospectiva Café com DEV HE:Rio 12/07 </li>
      </ul>
      
    </div>
    
  	<div class="grid">
      <div class="collumn">
        <h3>GitHub Repos</h3>
        <ul>
          <li>startupdev.github.com <span>Startup DEV Website</span></li>
          <li>pah<span>Command line interface to generate rails apps used at HE:labs.</span> </li>
          <li>acts_as_hashed<span>acts_as_hashed makes it easier to create unique non-discoverable URIs and all other sorts of uuid you may need in your app.</span> </li>
        </ul>
      
      </div>
      
    	<div class="grid">
        <div class="collumn">
          <h3>Últimos Tweets</h3>
          <ul>
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas eget.  adipiscing elit. </li>
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas eget. </li>
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas eget.  </li>
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas eget. Lorem ipsum dolor sit amet </li>
          </ul>
      
        </div>
    
		<p>
		  Copyright &copy; 2013 - Time HE:labs -
		  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
		</p>
	</div>
</footer>



<script type="text/javascript">
      var disqus_shortname = 'helabsblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://helabs.com.br/blog/2013/06/11/evitando-problemas-com-datas-e-time-zones-no-rails/';
        var disqus_url = 'http://helabs.com.br/blog/2013/06/11/evitando-problemas-com-datas-e-time-zones-no-rails/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#appId=294124694041877&xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
  window.fbAsyncInit = function(){
    FB.Event.subscribe('edge.create', function(targetUrl) {
      _gaq.push(['_trackSocial', 'facebook', 'like', targetUrl]);
    });
    FB.Event.subscribe('edge.remove', function(targetUrl) {
      _gaq.push(['_trackSocial', 'facebook', 'unlike', targetUrl]);
    });
    FB.Event.subscribe('message.send', function(targetUrl) {
      _gaq.push(['_trackSocial', 'facebook', 'send', targetUrl]);
    });
  }
</script>





<script type="text/javascript" charset="utf-8">
  window.twttr = (function (d,s,id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
    js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
  }(document, "script", "twitter-wjs"));
  function extractParamFromUri(uri, paramName) {
    if (!uri) {
      return;
    }
    var regex = new RegExp('[\\?&#]' + paramName + '=([^&#]*)');
    var params = regex.exec(uri);
    if (params != null) {
      return unescape(params[1]);
    }
    return;
  }
  function trackTwitter(intent_event) {
    if (intent_event) {
      var opt_pagePath;
      if (intent_event.target && intent_event.target.nodeName == 'IFRAME') {
        opt_target = extractParamFromUri(intent_event.target.src, 'url');
      }
      _gaq.push(['_trackSocial', 'twitter', 'tweet', opt_pagePath]);
    }
  }

  //Wrap event bindings - Wait for async js to load
  twttr.ready(function (twttr) {
    //event bindings
    twttr.events.bind('tweet', trackTwitter);
  });
</script>



	</body>
</html>
